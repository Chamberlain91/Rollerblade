#!/usr/bin/env node
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var merge=_interopDefault(require("deepmerge")),minimist=_interopDefault(require("minimist")),path=_interopDefault(require("path")),fs=_interopDefault(require("fs"));function __awaiter(e,r,t,o){return new(t||(t=Promise))(function(n,a){function i(e){try{l(o.next(e))}catch(e){a(e)}}function s(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){e.done?n(e.value):new t(function(r){r(e.value)}).then(i,s)}l((o=o.apply(e,r||[])).next())})}function __generator(e,r){var t,o,n,a,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;i;)try{if(t=1,o&&(n=o[2&a[0]?"return":a[0]?"throw":"next"])&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[0,n.value]),a[0]){case 0:case 1:n=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,o=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(n=(n=i.trys).length>0&&n[n.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){i.label=a[1];break}if(6===a[0]&&i.label<n[1]){i.label=n[1],n=a;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(a);break}n[2]&&i.ops.pop(),i.trys.pop();continue}a=r.call(e,i)}catch(e){a=[6,e],o=0}finally{t=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}function __values(e){var r="function"==typeof Symbol&&e[Symbol.iterator],t=0;return r?r.call(e):{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}var path$1=require("path"),rollup=require("rollup"),typescript=require("rollup-plugin-typescript2"),sourcemaps=require("rollup-plugin-sourcemaps"),commonjs=require("rollup-plugin-commonjs"),minify=require("rollup-plugin-babel-minify"),json=require("rollup-plugin-json"),cacheRoot=path$1.join(path$1.resolve(__filename,process.cwd()),".cache");function rollerblade(e){return __awaiter(this,void 0,void 0,function(){var r,t,o,n,a,i,s,l,c,u,p;return __generator(this,function(f){switch(f.label){case 0:if(0!=e.length)return[3,1];throw new Error("Must specify at least one path to a file.");case 1:r=new Array,f.label=2;case 2:f.trys.push([2,8,9,10]),t=__values(e),o=t.next(),f.label=3;case 3:return o.done?[3,7]:(void 0===(n=o.value).format&&(n.format="es"),void 0===n.sourcemap&&(n.sourcemap=!0),void 0===n.tsconfig&&void 0===n.target&&(n.target="es5"),void 0!==n.target&&void 0!==n.tsconfig&&console.warn("Both target and tsconfig specified, target will be overriden by tsconfig."),console.log(n),a=path$1.parse(n.output||n.input),i=path$1.join(a.dir,a.name+".js.map"),s=path$1.join(a.dir,a.name+".js"),[4,rollup.rollup({input:n.input,treeshake:!0,plugins:[json(),typescript({cacheRoot:cacheRoot,useTsconfigDeclarationDir:!0,tsconfigDefaults:{compilerOptions:{moduleResolution:"node",target:n.target,lib:["es2018","es2017","es2016","es2015","dom"],declaration:!0,declarationDir:a.dir,allowSyntheticDefaultImports:!0,experimentalDecorators:!0,emitDecoratorMetadata:!0,downlevelIteration:!0,noImplicitAny:!0,noImplicitReturns:!0,noImplicitThis:!0}},tsconfigOverride:merge(n.tsconfig||{},{compilerOptions:{sourceMap:n.sourcemap}})}),commonjs(),minify({comments:!1}),sourcemaps()]})]);case 4:return[4,f.sent().generate({format:n.format,sourcemapFile:i,sourcemap:n.sourcemap})];case 5:l=f.sent(),r.push({js:{file:s,content:l.code+(n.sourcemap?"//# sourceMappingURL=./"+a.name+".js.map":"")},map:n.sourcemap?{file:i,content:l.map}:void 0}),f.label=6;case 6:return o=t.next(),[3,3];case 7:return[3,10];case 8:return c=f.sent(),u={error:c},[3,10];case 9:try{o&&!o.done&&(p=t.return)&&p.call(t)}finally{if(u)throw u.error}return[7];case 10:return[2,r];case 11:return[2]}})})}var paths,rootDir=path.resolve("package.json",process.cwd()),command=minimist(process.argv.slice(2),{alias:{s:"sourcemap",f:"format"},default:{s:!1,f:"es"},boolean:["s"]});if(0==command._.length){var pkg=require(path.join(process.cwd(),"package.json"));pkg&&pkg.rollerblade?paths=pkg.rollerblade.map(function(e){return"string"==typeof e?{input:e}:e}):(console.log("Usage: rollerblade ./myfile.ts -f cjs -s"),console.log("Must specify at least one ts entry file or be configured in package.json."),process.exit(0))}else paths=command._.filter(function(e){return"string"==typeof e}).map(function(e){var r=path.resolve(e,process.cwd());return{input:path.join(r,e),sourcemap:command.sourcemap,format:command.format}});paths&&rollerblade(paths).then(function(e){try{for(var r=__values(e),t=r.next();!t.done;t=r.next()){var o=t.value;fs.writeFileSync(o.js.file,o.js.content),command.sourcemap&&o.map&&fs.writeFileSync(o.map.file,o.map.content)}}catch(e){n={error:e}}finally{try{t&&!t.done&&(a=r.return)&&a.call(r)}finally{if(n)throw n.error}}var n,a});
