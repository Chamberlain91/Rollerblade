#!/usr/bin/env node
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var merge=_interopDefault(require("deepmerge")),minimist=_interopDefault(require("minimist")),path=require("path"),path__default=_interopDefault(path),fs=_interopDefault(require("fs"));function __awaiter(e,o,t,r){return new(t||(t=Promise))(function(n,l){function i(e){try{s(r.next(e))}catch(e){l(e)}}function a(e){try{s(r.throw(e))}catch(e){l(e)}}function s(e){e.done?n(e.value):new t(function(o){o(e.value)}).then(i,a)}s((r=r.apply(e,o||[])).next())})}function __generator(e,o){var t,r,n,l,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return l={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function a(l){return function(a){return function(l){if(t)throw new TypeError("Generator is already executing.");for(;i;)try{if(t=1,r&&(n=r[2&l[0]?"return":l[0]?"throw":"next"])&&!(n=n.call(r,l[1])).done)return n;switch(r=0,n&&(l=[0,n.value]),l[0]){case 0:case 1:n=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,r=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(n=(n=i.trys).length>0&&n[n.length-1])&&(6===l[0]||2===l[0])){i=0;continue}if(3===l[0]&&(!n||l[1]>n[0]&&l[1]<n[3])){i.label=l[1];break}if(6===l[0]&&i.label<n[1]){i.label=n[1],n=l;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(l);break}n[2]&&i.ops.pop(),i.trys.pop();continue}l=o.call(e,i)}catch(e){l=[6,e],r=0}finally{t=n=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,a])}}}function __values(e){var o="function"==typeof Symbol&&e[Symbol.iterator],t=0;return o?o.call(e):{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}var path$1=require("path"),rollup=require("rollup"),typescript=require("rollup-plugin-typescript2"),sourcemaps=require("rollup-plugin-sourcemaps"),commonjs=require("rollup-plugin-commonjs"),minify=require("rollup-plugin-babel-minify"),json=require("rollup-plugin-json"),cacheRoot=path$1.join(path$1.resolve(__filename,process.cwd()),".cache");function rollerblade(e){return __awaiter(this,void 0,void 0,function(){var o,t,r,n,l,i,a,s,c,u,p;return __generator(this,function(f){switch(f.label){case 0:if(0!=e.length)return[3,1];throw new Error("Must specify at least one path to a file.");case 1:o=new Array,f.label=2;case 2:f.trys.push([2,8,9,10]),t=__values(e),r=t.next(),f.label=3;case 3:return r.done?[3,7]:(void 0===(n=r.value).format&&(n.format="es"),void 0===n.sourcemap&&(n.sourcemap=!1),void 0===n.tsconfig&&void 0===n.target&&(n.target="es5"),void 0!==n.target&&void 0!==n.tsconfig&&console.warn("Both target and tsconfig specified, target will be overriden by tsconfig."),console.log(n),l=path$1.parse(n.output||n.input),i=path$1.join(l.dir,l.name+".js.map"),a=path$1.join(l.dir,l.name+".js"),[4,rollup.rollup({input:n.input,treeshake:!0,plugins:[json(),typescript({cacheRoot:cacheRoot,useTsconfigDeclarationDir:!0,tsconfigDefaults:{compilerOptions:{moduleResolution:"node",target:n.target,lib:["es2018","es2017","es2016","es2015","dom"],declaration:!0,declarationDir:l.dir,allowSyntheticDefaultImports:!0,experimentalDecorators:!0,emitDecoratorMetadata:!0,downlevelIteration:!0,noImplicitReturns:!0,noImplicitThis:!0}},tsconfigOverride:merge(n.tsconfig||{},{compilerOptions:{sourceMap:n.sourcemap}})}),commonjs(),minify({comments:!1}),sourcemaps()]})]);case 4:return[4,f.sent().generate({format:n.format,sourcemapFile:i,sourcemap:n.sourcemap})];case 5:s=f.sent(),o.push({js:{file:a,content:s.code+(n.sourcemap?"//# sourceMappingURL=./"+l.name+".js.map":"")},map:n.sourcemap?{file:i,content:s.map}:void 0}),f.label=6;case 6:return r=t.next(),[3,3];case 7:return[3,10];case 8:return c=f.sent(),u={error:c},[3,10];case 9:try{r&&!r.done&&(p=t.return)&&p.call(t)}finally{if(u)throw u.error}return[7];case 10:return[2,o];case 11:return[2]}})})}var config,command=minimist(process.argv.slice(2),{alias:{o:"output",m:"sourcemap",f:"format",t:"target",h:"help"},default:{o:void 0,h:!1,s:!1,t:"es5",f:"es"},boolean:["s","h"]});if(command.help)printHelp(!0),process.exit(0);else if(0==command._.length){var pkg=require(path__default.join(process.cwd(),"package.json"));if(pkg&&pkg.rollerblade){var config_1=pkg.rollerblade;config_1=config_1.map(function(e){return"string"==typeof e&&(e={input:e}),e})}}else if(1==command._.length){var input=command._[0],dir=path__default.resolve(input,process.cwd());config=[{input:input,sourcemap:command.sourcemap,format:command.format}]}function printHelp(e){console.log("Usage:\t`rollerblade [options] input`"),console.log("or\t`rollerblade` configured with package.json"),console.log(""),console.log("Must specify entry file or be configured in package.json."),e&&(console.log(""),console.log("Options:"),console.log(""),console.log("--output or -o"),console.log("\tSpecifies output file path."),console.log("\tIf not specified, writes adjacent to input file with .js extension."),console.log(""),console.log("--sourcemap or -m"),console.log("\tEnable writing sourcemaps ( writes adjacent to output with .js.map extension )."),console.log("\tDisabled by default."),console.log(""),console.log("--format or -f"),console.log("\tSets the desired module format ( amd, cjs, es, iife or umd )."),console.log("\tWill use `es` by default."),console.log(""),console.log("--target or -t"),console.log("\tSets the desired js version target ( es3, es5, es2015... etc )."),console.log("\tA tsconfig.json file will override this settings."),console.log("\tWill use `es5` by default."),console.log(""),console.log("--help or -h"),console.log("\tDisplays this help text and ignores all other options.")),console.log(""),console.log("Example:"),console.log("        rollerblade ./myfile.ts -f cjs -s"),e||(console.log(""),console.log("Use option --help or -h for more information."))}function mkdirpath(e){var o=path.dirname(e);try{fs.readdirSync(o)}catch(e){mkdirpath(o);try{fs.mkdirSync(o)}catch(e){if("EEXIST"!==e.code)throw e}}}void 0!==config?rollerblade(config).then(function(e){try{for(var o=__values(e),t=o.next();!t.done;t=o.next()){var r=t.value;mkdirpath(r.js.file),fs.writeFileSync(r.js.file,r.js.content),r.map&&fs.writeFileSync(r.map.file,r.map.content)}}catch(e){n={error:e}}finally{try{t&&!t.done&&(l=o.return)&&l.call(o)}finally{if(n)throw n.error}}var n,l}):(printHelp(!1),process.exit(0));
